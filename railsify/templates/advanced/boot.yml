---
boot:
  - snippets:
    - file: Gemfile
      insert:
        - code: |
                gem 'devise'
                gem 'administrate'
          where: end

  - tasks:
    - command: bundle install
    - command: bundle exec rake db:drop db:create
    - command: bundle exec rails generate controller Frontend/Home index

  - snippets:
    - file: config/routes.rb
      replace:
        - code: namespace :frontend do
          with: "scope module: 'frontend' do"
        - code: "get 'home/index'"
          with: "  root 'home#index'"

    - file: app/views/frontend/home/index.html.erb
      insert:
        - code: |+
                <% provide(:title, 'Index page') %>

          where: begin
        - code: |

                <% content_for :footer_scripts do %>
                  <script>
                    !function() {
                      console.log('Hello from Frontend::Home#index');
                    }();
                  </script>
                <% end %>
          where: end

  # Install Devise
  - tasks:
    - command: bundle exec rails generate devise:install
    - command: bundle exec rails generate devise User
    - command: bundle exec rails generate migration AddRoleToUser role:integer

  - snippets:
    - file: config/routes.rb
      insert:
        - code: "\n"
          where: after
          selector: devise_for :users

    - file: app/views/layouts/application.html.erb
      insert:
        - code: |+
                <%= render 'shared/alerts' %>
          where: after
          selector: |
                    <body>

    - file: config/environments/development.rb
      insert:
        - code: |2+

              config.action_mailer.default_url_options = { host: 'localhost', port: 3000 }
          where: before
          selector: |
                    end

    - file: app/models/user.rb
      insert:
        - code: |2+
              enum role: [:visitor, :admin]

          where: after
          selector: |
                    class User < ActiveRecord::Base

    - file: db/migrate/*_add_role_to_user.rb
      replace:
        - code: add_column :users, :role, :integer
          with: 'add_column :users, :role, :integer, default: 0'

  # Run pending migrations
  - tasks:
    - command: bundle exec rake db:migrate

  # Install Administrate
  - tasks:
    # Because of the strange bug it is required to run command below twice
    - command: DISABLE_SPRING=1 bundle exec rails generate administrate:install
    - command: DISABLE_SPRING=1 bundle exec rails generate administrate:install

  - snippets:
    - file: app/controllers/admin/application_controller.rb
      insert:
        - code: |2+
                  authenticate_user!
                  return if current_user.admin?
                  redirect_to root_path, alert: t('authorization.unauthorized_access')
          where: after
          selector: |
                    # TODO Add authentication logic here.

  - tasks:
    - command: echo 'All set, rock on!'
